{"version":3,"file":"client.js","names":["_constants","require","_utils","updateTags","type","tags","headElement","document","head","querySelector","TAG_NAMES","HEAD","tagNodes","querySelectorAll","HELMET_ATTRIBUTE","allTags","oldTags","newTags","tag","newElement","createElement","key","value","Object","entries","prototype","hasOwnProperty","call","name","HTML_TAG_MAP","TAG_PROPERTIES","INNER_HTML","innerHTML","CSS_TEXT","styleSheet","cssText","appendChild","createTextNode","setAttribute","attrs","attributes","push","i","isEqualNode","splice","length","forEach","parentNode","removeChild","updateAttributes","tagName","props","elementTag","getElementsByTagName","helmetAttributeString","getAttribute","helmetAttributes","split","attributesToRemove","attributeKeys","prop","keys","attr","includes","indexToSave","indexOf","removeAttribute","join","updateTitle","title","undefined","flattenArray","TITLE","commitTagChanges","newState","firstRender","base","bodyAttributes","defer","htmlAttributes","links","meta","noscript","onChangeClientState","script","style","titleAttributes","BODY","HTML","tagUpdates","baseTag","BASE","linkTags","LINK","metaTags","META","noscriptTags","NOSCRIPT","scriptTags","SCRIPT","styleTags","STYLE","resultTags","addedTags","removedTags","tagType"],"sources":["../../src/client.ts"],"sourcesContent":["import {\n  HELMET_ATTRIBUTE,\n  HTML_TAG_MAP,\n  TAG_NAMES,\n  TAG_PROPERTIES,\n} from './constants';\n\nimport type {\n  AggregatedState,\n  BodyProps,\n  HelmetChildProps,\n  HelmetTags,\n  HtmlProps,\n  StateUpdate,\n} from './types';\n\nimport { flattenArray } from './utils';\n\ntype TagUpdates = {\n  allTags: HTMLElement[];\n  oldTags: HTMLElement[];\n  newTags: HTMLElement[];\n};\n\ntype TagUpdateList = Record<string, TagUpdates>;\n\n/**\n * Replaces HTML elements previously added to the DOM's head by React Helmet\n * by the set of given elements (tags). For any given element that matches\n * exactly an element already present in the head no actual DOM modification\n * happens, it just keeps already present element. Returns arrays of newly\n * added (newTags) and removed (oldTags) elements.\n */\nfunction updateTags(type: string, tags: HelmetChildProps[]) {\n  // TODO: Do we really need the fallback here? document.head is supposed to be\n  // always defined.\n  // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n  const headElement = document.head || document.querySelector(TAG_NAMES.HEAD);\n\n  const tagNodes = headElement.querySelectorAll<HTMLElement>(`${type}[${HELMET_ATTRIBUTE}]`);\n  const allTags: HTMLElement[] = [];\n  const oldTags: HTMLElement[] = [...tagNodes];\n  const newTags: HTMLElement[] = [];\n\n  for (const tag of tags) {\n    const newElement = document.createElement(type);\n\n    // TODO: Well, the typing within this block is bad, and should be improved.\n    for (const [key, value] of Object.entries(tag)) {\n      // TODO: Revisit layer.\n      // eslint-disable-next-line prefer-object-has-own\n      if (Object.prototype.hasOwnProperty.call(tag, key)) {\n        const name = HTML_TAG_MAP[key] ?? key;\n        if (name as TAG_PROPERTIES === TAG_PROPERTIES.INNER_HTML) {\n          newElement.innerHTML = value as string;\n        } else if (name as TAG_PROPERTIES === TAG_PROPERTIES.CSS_TEXT) {\n          // TODO: Not sure when this is true?\n          // @ts-expect-error \"pre-existing\"\n          if (newElement.styleSheet) {\n            // @ts-expect-error \"pre-existing\"\n            (newElement.styleSheet as CSSStyleDeclaration).cssText = (\n              tag as CSSStyleDeclaration).cssText;\n          } else {\n            newElement.appendChild(document.createTextNode(\n              (tag as CSSStyleDeclaration).cssText,\n            ));\n          }\n        } else {\n          newElement.setAttribute(name, (value as string | undefined) ?? '');\n        }\n      }\n    }\n\n    newElement.setAttribute(HELMET_ATTRIBUTE, 'true');\n\n    const attrs = {} as HTMLElement;\n    for (const { name, value } of newElement.attributes) {\n      (attrs[name as keyof HTMLElement] as unknown) = value;\n    }\n    allTags.push(attrs);\n\n    // Remove a duplicate tag from domTagstoRemove, so it isn't cleared.\n    for (let i = 0; ; ++i) {\n      if (newElement.isEqualNode(oldTags[i]!)) {\n        oldTags.splice(i, 1);\n        break;\n      }\n      if (i >= oldTags.length) {\n        newTags.push(newElement);\n        break;\n      }\n    }\n  }\n\n  oldTags.forEach((tag: Node) => tag.parentNode?.removeChild(tag));\n  newTags.forEach((tag) => headElement.appendChild(tag));\n\n  // TODO: Do we really need this return value anywhere? Especially `oldTags`\n  // that have been removed from DOM already?\n  return {\n    allTags,\n    newTags,\n    oldTags,\n  };\n}\n\nfunction updateAttributes(tagName: string, props: BodyProps | HtmlProps) {\n  const [elementTag] = document.getElementsByTagName(tagName);\n\n  if (!elementTag) {\n    return;\n  }\n\n  const helmetAttributeString = elementTag.getAttribute(HELMET_ATTRIBUTE);\n  const helmetAttributes = helmetAttributeString ? helmetAttributeString.split(',') : [];\n  const attributesToRemove = [...helmetAttributes];\n\n  const attributeKeys: string[] = [];\n  for (const prop of Object.keys(props)) {\n    // TODO: See a comment below.\n    attributeKeys.push(HTML_TAG_MAP[prop] ?? prop);\n  }\n\n  for (const [key, value] of Object.entries(props)) {\n    // TODO: Get rid of the mapping later. It is not really needed, as HTML\n    // attribute names are case-insensitive. However, our related logic may\n    // still be case dependent - we should be careful about it.\n    const attr = HTML_TAG_MAP[key] ?? key;\n    if (elementTag.getAttribute(attr) !== value) {\n      // TODO: That ?? '' piece is here to keep the legacy behavior for now,\n      // I guess later we should prefer to consider attrbiutes with \"undefined\"\n      // value as not set.\n      elementTag.setAttribute(attr, value as string | undefined ?? '');\n    }\n\n    if (!helmetAttributes.includes(attr)) {\n      helmetAttributes.push(attr);\n    }\n\n    const indexToSave = attributesToRemove.indexOf(attr);\n    if (indexToSave !== -1) {\n      attributesToRemove.splice(indexToSave, 1);\n    }\n  }\n\n  for (let i = attributesToRemove.length - 1; i >= 0; i -= 1) {\n    elementTag.removeAttribute(attributesToRemove[i]!);\n  }\n\n  if (helmetAttributes.length === attributesToRemove.length) {\n    elementTag.removeAttribute(HELMET_ATTRIBUTE);\n  } else if (elementTag.getAttribute(HELMET_ATTRIBUTE) !== attributeKeys.join(',')) {\n    elementTag.setAttribute(HELMET_ATTRIBUTE, attributeKeys.join(','));\n  }\n}\n\nfunction updateTitle(\n  title: string | undefined,\n  attributes: BodyProps | HtmlProps,\n) {\n  if (title !== undefined && document.title !== title) {\n    document.title = flattenArray(title);\n  }\n\n  updateAttributes(TAG_NAMES.TITLE, attributes);\n}\n\nexport function commitTagChanges(\n  newState: AggregatedState,\n  firstRender: boolean,\n): void {\n  const {\n    base,\n    bodyAttributes,\n    defer,\n    htmlAttributes,\n    links,\n    meta,\n    noscript,\n    onChangeClientState,\n    script,\n    style,\n    title,\n    titleAttributes,\n  } = newState;\n  updateAttributes(TAG_NAMES.BODY, bodyAttributes ?? {});\n  updateAttributes(TAG_NAMES.HTML, htmlAttributes ?? {});\n\n  updateTitle(title, titleAttributes!);\n\n  const tagUpdates: TagUpdateList = {\n    baseTag: updateTags(TAG_NAMES.BASE, base ? [base] : []),\n    linkTags: updateTags(TAG_NAMES.LINK, links ?? []),\n    metaTags: updateTags(TAG_NAMES.META, meta ?? []),\n    noscriptTags: updateTags(TAG_NAMES.NOSCRIPT, noscript ?? []),\n    scriptTags: updateTags(TAG_NAMES.SCRIPT, script ?? []),\n    styleTags: updateTags(TAG_NAMES.STYLE, style ?? []),\n  };\n\n  const resultTags: StateUpdate = {\n    baseTag: [],\n    bodyAttributes: {},\n    defer: defer ?? false,\n    htmlAttributes: {},\n    linkTags: [],\n    metaTags: [],\n    noscriptTags: [],\n    onChangeClientState: onChangeClientState ?? (() => undefined),\n    scriptTags: [],\n    styleTags: [],\n    title: title ?? '',\n    titleAttributes: {},\n  };\n\n  const addedTags: Partial<HelmetTags> = {};\n  const removedTags: Partial<HelmetTags> = {};\n\n  Object.keys(tagUpdates).forEach((tagType) => {\n    const { allTags, newTags, oldTags } = tagUpdates[tagType]!;\n\n    (resultTags[tagType as keyof HelmetTags] as HTMLElement[]) = allTags;\n\n    if (newTags.length) {\n      (addedTags[tagType as keyof HelmetTags] as HTMLElement[]) = newTags;\n    }\n    if (oldTags.length) {\n      (removedTags[tagType as keyof HelmetTags] as HTMLElement[])\n        = tagUpdates[tagType]!.oldTags;\n    }\n  });\n\n  if (firstRender\n    || Object.keys(addedTags).length\n    || Object.keys(removedTags).length\n  ) {\n    onChangeClientState?.(resultTags, addedTags, removedTags);\n  }\n}\n"],"mappings":"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","ignoreList":[]}