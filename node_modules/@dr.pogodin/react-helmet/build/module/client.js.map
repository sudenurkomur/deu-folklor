{"version":3,"file":"client.js","names":["HELMET_ATTRIBUTE","HTML_TAG_MAP","TAG_NAMES","TAG_PROPERTIES","flattenArray","updateTags","type","tags","headElement","document","head","querySelector","HEAD","tagNodes","querySelectorAll","allTags","oldTags","newTags","tag","newElement","createElement","key","value","Object","entries","prototype","hasOwnProperty","call","name","INNER_HTML","innerHTML","CSS_TEXT","styleSheet","cssText","appendChild","createTextNode","setAttribute","attrs","attributes","push","i","isEqualNode","splice","length","forEach","parentNode","removeChild","updateAttributes","tagName","props","elementTag","getElementsByTagName","helmetAttributeString","getAttribute","helmetAttributes","split","attributesToRemove","attributeKeys","prop","keys","attr","includes","indexToSave","indexOf","removeAttribute","join","updateTitle","title","undefined","TITLE","commitTagChanges","newState","firstRender","base","bodyAttributes","defer","htmlAttributes","links","meta","noscript","onChangeClientState","script","style","titleAttributes","BODY","HTML","tagUpdates","baseTag","BASE","linkTags","LINK","metaTags","META","noscriptTags","NOSCRIPT","scriptTags","SCRIPT","styleTags","STYLE","resultTags","addedTags","removedTags","tagType"],"sources":["../../src/client.ts"],"sourcesContent":["import {\n  HELMET_ATTRIBUTE,\n  HTML_TAG_MAP,\n  TAG_NAMES,\n  TAG_PROPERTIES,\n} from './constants';\n\nimport type {\n  AggregatedState,\n  BodyProps,\n  HelmetChildProps,\n  HelmetTags,\n  HtmlProps,\n  StateUpdate,\n} from './types';\n\nimport { flattenArray } from './utils';\n\ntype TagUpdates = {\n  allTags: HTMLElement[];\n  oldTags: HTMLElement[];\n  newTags: HTMLElement[];\n};\n\ntype TagUpdateList = Record<string, TagUpdates>;\n\n/**\n * Replaces HTML elements previously added to the DOM's head by React Helmet\n * by the set of given elements (tags). For any given element that matches\n * exactly an element already present in the head no actual DOM modification\n * happens, it just keeps already present element. Returns arrays of newly\n * added (newTags) and removed (oldTags) elements.\n */\nfunction updateTags(type: string, tags: HelmetChildProps[]) {\n  // TODO: Do we really need the fallback here? document.head is supposed to be\n  // always defined.\n  // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n  const headElement = document.head || document.querySelector(TAG_NAMES.HEAD);\n\n  const tagNodes = headElement.querySelectorAll<HTMLElement>(`${type}[${HELMET_ATTRIBUTE}]`);\n  const allTags: HTMLElement[] = [];\n  const oldTags: HTMLElement[] = [...tagNodes];\n  const newTags: HTMLElement[] = [];\n\n  for (const tag of tags) {\n    const newElement = document.createElement(type);\n\n    // TODO: Well, the typing within this block is bad, and should be improved.\n    for (const [key, value] of Object.entries(tag)) {\n      // TODO: Revisit layer.\n      // eslint-disable-next-line prefer-object-has-own\n      if (Object.prototype.hasOwnProperty.call(tag, key)) {\n        const name = HTML_TAG_MAP[key] ?? key;\n        if (name as TAG_PROPERTIES === TAG_PROPERTIES.INNER_HTML) {\n          newElement.innerHTML = value as string;\n        } else if (name as TAG_PROPERTIES === TAG_PROPERTIES.CSS_TEXT) {\n          // TODO: Not sure when this is true?\n          // @ts-expect-error \"pre-existing\"\n          if (newElement.styleSheet) {\n            // @ts-expect-error \"pre-existing\"\n            (newElement.styleSheet as CSSStyleDeclaration).cssText = (\n              tag as CSSStyleDeclaration).cssText;\n          } else {\n            newElement.appendChild(document.createTextNode(\n              (tag as CSSStyleDeclaration).cssText,\n            ));\n          }\n        } else {\n          newElement.setAttribute(name, (value as string | undefined) ?? '');\n        }\n      }\n    }\n\n    newElement.setAttribute(HELMET_ATTRIBUTE, 'true');\n\n    const attrs = {} as HTMLElement;\n    for (const { name, value } of newElement.attributes) {\n      (attrs[name as keyof HTMLElement] as unknown) = value;\n    }\n    allTags.push(attrs);\n\n    // Remove a duplicate tag from domTagstoRemove, so it isn't cleared.\n    for (let i = 0; ; ++i) {\n      if (newElement.isEqualNode(oldTags[i]!)) {\n        oldTags.splice(i, 1);\n        break;\n      }\n      if (i >= oldTags.length) {\n        newTags.push(newElement);\n        break;\n      }\n    }\n  }\n\n  oldTags.forEach((tag: Node) => tag.parentNode?.removeChild(tag));\n  newTags.forEach((tag) => headElement.appendChild(tag));\n\n  // TODO: Do we really need this return value anywhere? Especially `oldTags`\n  // that have been removed from DOM already?\n  return {\n    allTags,\n    newTags,\n    oldTags,\n  };\n}\n\nfunction updateAttributes(tagName: string, props: BodyProps | HtmlProps) {\n  const [elementTag] = document.getElementsByTagName(tagName);\n\n  if (!elementTag) {\n    return;\n  }\n\n  const helmetAttributeString = elementTag.getAttribute(HELMET_ATTRIBUTE);\n  const helmetAttributes = helmetAttributeString ? helmetAttributeString.split(',') : [];\n  const attributesToRemove = [...helmetAttributes];\n\n  const attributeKeys: string[] = [];\n  for (const prop of Object.keys(props)) {\n    // TODO: See a comment below.\n    attributeKeys.push(HTML_TAG_MAP[prop] ?? prop);\n  }\n\n  for (const [key, value] of Object.entries(props)) {\n    // TODO: Get rid of the mapping later. It is not really needed, as HTML\n    // attribute names are case-insensitive. However, our related logic may\n    // still be case dependent - we should be careful about it.\n    const attr = HTML_TAG_MAP[key] ?? key;\n    if (elementTag.getAttribute(attr) !== value) {\n      // TODO: That ?? '' piece is here to keep the legacy behavior for now,\n      // I guess later we should prefer to consider attrbiutes with \"undefined\"\n      // value as not set.\n      elementTag.setAttribute(attr, value as string | undefined ?? '');\n    }\n\n    if (!helmetAttributes.includes(attr)) {\n      helmetAttributes.push(attr);\n    }\n\n    const indexToSave = attributesToRemove.indexOf(attr);\n    if (indexToSave !== -1) {\n      attributesToRemove.splice(indexToSave, 1);\n    }\n  }\n\n  for (let i = attributesToRemove.length - 1; i >= 0; i -= 1) {\n    elementTag.removeAttribute(attributesToRemove[i]!);\n  }\n\n  if (helmetAttributes.length === attributesToRemove.length) {\n    elementTag.removeAttribute(HELMET_ATTRIBUTE);\n  } else if (elementTag.getAttribute(HELMET_ATTRIBUTE) !== attributeKeys.join(',')) {\n    elementTag.setAttribute(HELMET_ATTRIBUTE, attributeKeys.join(','));\n  }\n}\n\nfunction updateTitle(\n  title: string | undefined,\n  attributes: BodyProps | HtmlProps,\n) {\n  if (title !== undefined && document.title !== title) {\n    document.title = flattenArray(title);\n  }\n\n  updateAttributes(TAG_NAMES.TITLE, attributes);\n}\n\nexport function commitTagChanges(\n  newState: AggregatedState,\n  firstRender: boolean,\n): void {\n  const {\n    base,\n    bodyAttributes,\n    defer,\n    htmlAttributes,\n    links,\n    meta,\n    noscript,\n    onChangeClientState,\n    script,\n    style,\n    title,\n    titleAttributes,\n  } = newState;\n  updateAttributes(TAG_NAMES.BODY, bodyAttributes ?? {});\n  updateAttributes(TAG_NAMES.HTML, htmlAttributes ?? {});\n\n  updateTitle(title, titleAttributes!);\n\n  const tagUpdates: TagUpdateList = {\n    baseTag: updateTags(TAG_NAMES.BASE, base ? [base] : []),\n    linkTags: updateTags(TAG_NAMES.LINK, links ?? []),\n    metaTags: updateTags(TAG_NAMES.META, meta ?? []),\n    noscriptTags: updateTags(TAG_NAMES.NOSCRIPT, noscript ?? []),\n    scriptTags: updateTags(TAG_NAMES.SCRIPT, script ?? []),\n    styleTags: updateTags(TAG_NAMES.STYLE, style ?? []),\n  };\n\n  const resultTags: StateUpdate = {\n    baseTag: [],\n    bodyAttributes: {},\n    defer: defer ?? false,\n    htmlAttributes: {},\n    linkTags: [],\n    metaTags: [],\n    noscriptTags: [],\n    onChangeClientState: onChangeClientState ?? (() => undefined),\n    scriptTags: [],\n    styleTags: [],\n    title: title ?? '',\n    titleAttributes: {},\n  };\n\n  const addedTags: Partial<HelmetTags> = {};\n  const removedTags: Partial<HelmetTags> = {};\n\n  Object.keys(tagUpdates).forEach((tagType) => {\n    const { allTags, newTags, oldTags } = tagUpdates[tagType]!;\n\n    (resultTags[tagType as keyof HelmetTags] as HTMLElement[]) = allTags;\n\n    if (newTags.length) {\n      (addedTags[tagType as keyof HelmetTags] as HTMLElement[]) = newTags;\n    }\n    if (oldTags.length) {\n      (removedTags[tagType as keyof HelmetTags] as HTMLElement[])\n        = tagUpdates[tagType]!.oldTags;\n    }\n  });\n\n  if (firstRender\n    || Object.keys(addedTags).length\n    || Object.keys(removedTags).length\n  ) {\n    onChangeClientState?.(resultTags, addedTags, removedTags);\n  }\n}\n"],"mappings":"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","ignoreList":[]}